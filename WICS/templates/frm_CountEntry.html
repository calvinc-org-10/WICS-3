{% extends "WICS_common.html" %}
{% load widget_tweaks %}

{% block tTitle %}Count Entry{% endblock %}

{% block boddy %}
test 2105
    <div class="container text-center mx-auto">
    <div class="row">
        <div class="col-10 fs-1">
            <u>{{ orgname }}</u>
            <br>Count Entry
        </div>
        <div class="col-2 text-end"> {{ uname }} </div>
    </div>
    <div class="row"> <!-- status messages -->

        <div id="wait_spinner" class="spinner-border text-success" style="display:none"></div>
{% comment %}
        {% if changes_saved.main %}
            <div class="alert alert-success p-0 alert-dismissible fade show">
                <button type="button" class="btn-close p-0" data-bs-dismiss="alert"></button>
                This Material record successfully saved.
                ChDat: {{ changed_data.main }}
            </div>
        {% endif %}
        {% if changes_saved.counts %}
            <div class="alert alert-success p-0 alert-dismissible fade show">
                <button type="button" class="btn-close p-0" data-bs-dismiss="alert"></button>
                Count changes for this Material record successfully saved.
                ChDat: {{ changed_data.counts }}
            </div>
        {% endif %}
        {% if changes_saved.schedule %}
            <div class="alert alert-success p-0 alert-dismissible fade show">
                <button type="button" class="btn-close p-0" data-bs-dismiss="alert"></button>
                Count Schedule changes for this Material record successfully saved.
                ChDat: {{ changed_data.schedule }}
            </div>
        {% endif %}
{% endcomment %}
    </div><!-- row -->
    </div><!-- container -->
    <hr>

    <input type="text" id="RecPK" value={{ recNum }} disabled>
    <input type="hidden" id="formID" value={{ formID }} >

    <form id="form1" method="post">
        {% csrf_token %}
        <!-- form header -->
        s/b id: {{ frmMain.id }}
        s/b hidden org: {% render_field frmMain.org hidden="true" %}
        s/b errors: {{ frmMain.errors }}

        <!-- main part of form -->
        <!-- put initial focus on Material and/or init CountDate to today(local), skip CycCtID -->
        <div class="container">
        <div class="row">
            <div class="col-2">Count Dt: {% render_field frmMain.CountDate tabindex="-1" size="8" %}</div>
            <div class="col-2">CycCt ID: {% render_field frmMain.CycCtID tabindex="-1" size="5" %}</div>
            <div class="col-4">Material: {% render_field frmMain.Material onchange="loadExtraInfo()" %}</div>
            <div class="col-3">Actual Ctr: {% render_field frmMain.Counter %}</div>
            <div class="col-1">Loc Only: {{ frmMain.LocationOnly }} {# onchange="" #}  <!-- skip CTD_QTY if clicked --></div>
        </div>
        <div class="row">
            <div class="col-5">Ctd Qty: {% render_field frmMain.CTD_QTY_Expr size="35" onchange="sCE();" %}</div>
            <div class="col-1"><span class="container-md" id="EvalExpr">????</span></div>
            <div class="col-2">Building: {% render_field frmMain.BLDG size="5" %}</div>
            <div class="col-2">Location: {% render_field frmMain.LOCATION size="5" %}</div>
        </div>
        <div class="row">
            <div class="col-3">
                Possibly Not Rcvd: {{ frmMain.FLAG_PossiblyNotRecieved }}
                Mvmnt During Ct: {{ frmMain.FLAG_MovementDuringCount }}
            </div>
            <div class="col-4">
                Pkg ID/Desc: {% render_field frmMain.PKGID_Desc size="5" %}
                Tag Qty: {% render_field frmMain.TAGQTY size="5" %}
            </div>
            <div class="col-4">Notes: {% render_field frmMain.Notes size="35" %}</div>
        </div>
        <hr>
        <div class="row">
            <div class="col-4">Desc: {% render_field frmMatlInfo.Description size="30" %}</div>
            <div class="col-2">Pt Type: {% render_field frmMatlInfo.PartType style="width:7em" tabindex="-1" %}</div>
            <div class="col-6">
                Typ Container Qty: {% render_field frmMatlInfo.TypicalContainerQty size="4" tabindex="-1" %}
                Typ Plt Qty: {% render_field frmMatlInfo.TypicalPalletQty size="4" tabindex="-1" %}
            </div>
        </div>
        </div>
        <hr>

        Schedule Info
        <br>
        {% if noSchedInfo %}
            <div class="col-8">  <h3>MATERIAL NOT SCHEDULED FOR COUNT ON THIS DATE</h3>  </div>
            <div class="col-4">  <button type="button">Schedule Count</button>  </div>
        {% else %}
            {{ frmSchedInfo }}
        {% endif %}
{% comment %}
class CountSchedule(models.Model):
    CountDate = models.DateField(null=False)
    Material = models.ForeignKey(MaterialList, on_delete=models.RESTRICT)
    Counter = models.CharField(max_length=250, blank=True)
    Priority = models.CharField(max_length=50, blank=True)
    ReasonScheduled = models.CharField(max_length=250, blank=True)
    CMPrintFlag = models.BooleanField(null=True)
    Notes = models.CharField(max_length=250, blank=True)
{% endcomment %}

        <!-- form footer -->
        <hr>
        <div class="container">
            <div class="row mx-auto max-width=100%">
                <div class="col-2">
                    <button id="save_btn" type="submit">Save changes</button>
                </div>
                <div class="col-8">
                    <button id="btn_firstrec" type="button">First</button>
                    <button id="btn_prevrec" type="button">Prev</button>
                    <button id="btn_nextrec" type="button">Next</button>
                    <button id="btn_lastrec" type="button">Last</button>
                    <button id="btn_newrec" type="button">New</button>
                    GoTo Count Rec # {% render_field gotoForm.gotoItem id="gotoID" style="width:7em" form="dummy1" onchange="processGoToReq();" %}
                </div>
                <div class="col-2">
                    <button id="close_btn" type="button">Close Form</button>
                </div>
            </div>
        </div>
    </form>
    <form id="dummy1"></form>

    <script>
        var $form = $('form');
        var initialState;
        var modalCloseCheckResult, modalCloseCheckClosed;


        document.body.onload = function() {
            initialState = $form.serialize();
            if ({{ matlnum_changed }} != '' && {{ matlnum_changed }} != 'None') { document.getElementById("{{frmMain.Material.id_for_label}}").value = {{ matlnum_changed }} };
            }
        document.body.onbeforeunload = function() {
            document.getElementById("wait_spinner").style.display = "block";
            }

        document.getElementById("{{frmMain.CTD_QTY_Expr.id_for_label}}").addEventListener("onfocus",
            function(){ SkipCountIfLocationOnly(); });
        // document.getElementById("{{frmMain.CTD_QTY_Expr.id_for_label}}").addEventListener("onchange",
        function sCE(){ showCountExpr('{{frmMain.CTD_QTY_Expr.id_for_label}}', 'EvalExpr'); };

        // later, duplicate this for closeform (see document.body.onbeforeunload)
        document.getElementById("close_btn").addEventListener("click",
            function(evobj){
                if (confirmLeave()) {
                    window.close()
                }
            });

        function isFormChanged() {
            return !(initialState === $form.serialize());
        };

        function processGoToReq() {
            if (confirmLeave()) {
                loadCountEntryRec();
            }
        };

        // I'd like to use Bootstrap modals for this, but they're not really modal; they don't halt execution until dismissal
        /*
        document.getElementById('modalCloseCheck').addEventListener('hidden.bs.modal',
            function() {
               modalCloseCheckClosed = true;
            });
        */
        function confirmLeave(){
            if (isFormChanged()) {
                return confirm("This record has changed\nDo you really want to leave without saving?");
                // modalCloseCheckResult = false;
                // modalCloseCheckClosed = false;
                // $('#modalCloseCheck').modal();
                // while (!modalCloseCheckClosed) {
                //     // do nothing!
                //     } ;
                // alert(modalCloseCheckResult);
                // return modalCloseCheckResult;
            } else {
                return true;
            }
        };

// move to common???
        function showCountExpr(expr_fld, rslt) {
            document.getElementById(rslt).innerHTML = "= " + EvalExpr(document.getElementById(expr_fld).value);
        };

        function loadExtraInfo() {
            thisRecNum = document.getElementById('RecPK').value;
            ctdtID = document.getElementById('{{frmMain.CountDate.id_for_label}}');
            mtlnmID = document.getElementById('{{frmMain.Material.id_for_label}}');
            try {
                dVal = new Date(ctdtID.value)
            }
            catch {
                alert(ctdtID.value + " is not a valid date");
                ctdtID.focus();
                return;
            }
            {
                dmonth = ('00' + (dVal.getMonth() + 1)).slice(-2),
                dday = ('00' + dVal.getDate()).slice(-2),
                dyear = ('0000' + dVal.getFullYear()).slice(-4);
                dVal = [dyear, dmonth, dday].join('-');
            }
            newRec = "{% url 'CountEntryForm' 0 'passedCountDate' 1 %}"
            if (thisRecNum > 0) { newRec = newRec.replace("/0","/"+goID.value) };
            newRec = newRec.replace("passedCountDate",dVal)
            newRec = newRec.replace("/1","/"+mtlnmID.value)
            window.location = newRec;
        };
        function loadCountEntryRec() {
            fmID = document.getElementById("formID");
            goID = document.getElementById('gotoID');
            if (goID.value != null || goID.value == document.getElementById('RecPK').value) {
                // later, use reverse      path('FormBrowse/<slug:formname>/<int:recNum>',forms.FormBrowse,name='WICS_FormBrowse'),
                newRec_base = "{% url 'FormBrowse' formID 0 %}"
                newRec = newRec_base.replace("/0","/"+goID.value)
                // newRec = "/WICS/FormBrowse/" + fmID.value + "/" + goID.value;
                window.location = newRec;
            } else {
                goID.value = document.getElementById('RecPK').value;
            }
        };


        function processGoToReq() {
            if (confirmLeave()) {
                loadMaterialRec();
            }
        };

        function isFormChanged() {
            return !(initialState === $form.serialize());
        };

        // I'd like to use Bootstrap modals for this, but they're not really modal; they don't halt execution until dismissal
        /*
        document.getElementById('modalCloseCheck').addEventListener('hidden.bs.modal',
            function() {
               modalCloseCheckClosed = true;
            });
        */
        function confirmLeave(){
            if (isFormChanged()) {
                return confirm("This record has changed\nDo you really want to leave without saving?");
                // modalCloseCheckResult = false;
                // modalCloseCheckClosed = false;
                // $('#modalCloseCheck').modal();
                // while (!modalCloseCheckClosed) {
                //     // do nothing!
                //     } ;
                // alert(modalCloseCheckResult);
                // return modalCloseCheckResult;
            } else {
                return true;
            }
        };

        function SkipCountIfLocationOnly() {

        };

    </script>
    <script>
        function create_empty_user() {
            var form_idx = $('#id_form-TOTAL_FORMS').val()
            // check against max-forms before allowing add
            $('#form_set').append($('#empty_form').html().replace(/__prefix__/g, form_idx).replace("hidden",""))
            $('#id_form-TOTAL_FORMS').val(parseInt(form_idx) + 1)
        }
    </script>
{% endblock %}

